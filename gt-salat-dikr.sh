#!/bin/bash
# GT-salat-dikr - ุงููุณุฎุฉ ุงูููุงุฆูุฉ ุงูููุตูุญุฉ

set -euo pipefail

# --- ูุณุงุฑุงุช ุซุงุจุชุฉ ---
SCRIPT_DIR="$HOME/.GT-salat-dikr"
AZKAR_FILE="$SCRIPT_DIR/azkar.txt"
CONFIG_FILE="$SCRIPT_DIR/settings.conf"
TIMETABLE_FILE="$SCRIPT_DIR/timetable.json"
PID_FILE="$SCRIPT_DIR/.gt-salat-dikr-notify.pid"
ADHAN_FILE="$SCRIPT_DIR/adhan.ogg"
LOG_FILE="$SCRIPT_DIR/notify.log"

ALADHAN_API_URL="https://api.aladhan.com/v1/timings"
REPO_AZKAR_URL="https://raw.githubusercontent.com/SalehGNUTUX/GT-salat-dikr/main/azkar.txt"

# ---------------- ุชุญููู ุงูุฅุนุฏุงุฏุงุช ----------------
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
    else
        return 1
    fi
}

# ---------------- ุนุฑุถ ููุงููุช ุงูุตูุงุฉ ----------------
show_timetable() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "โ ูู ูุชู ุฅุนุฏุงุฏ ุงูุฅุนุฏุงุฏุงุช ุจุนุฏ. ุฌุฑุจ: gtsalat --settings"
        return 1
    fi
    
    source "$CONFIG_FILE"
    TODAY=$(date +%Y-%m-%d)
    URL="$ALADHAN_API_URL/$TODAY?latitude=$LAT&longitude=$LON&method=$METHOD_ID"
    
    if curl -fsSL "$URL" -o "$TIMETABLE_FILE"; then
        echo "ููุงููุช ุงูุตูุงุฉ ุงูููู ($CITY):"
        echo "================================"
        
        PRAYERS=("Fajr" "Sunrise" "Dhuhr" "Asr" "Maghrib" "Isha")
        AR_NAMES=("ุงููุฌุฑ" "ุงูุดุฑูู" "ุงูุธูุฑ" "ุงูุนุตุฑ" "ุงููุบุฑุจ" "ุงูุนุดุงุก")
        NOW_SECS=$(date +%s)
        
        for i in "${!PRAYERS[@]}"; do
            TIME=$(jq -r ".data.timings.${PRAYERS[$i]}" "$TIMETABLE_FILE" | cut -d" " -f1)
            if [ "$TIME" != "null" ]; then
                PRAYER_SECS=$(date -d "$(date +%Y-%m-%d) $TIME" +%s 2>/dev/null || date -d "$TIME" +%s)
                DIFF=$((PRAYER_SECS - NOW_SECS))
                
                if [ $DIFF -ge 0 ]; then
                    HOURS=$((DIFF / 3600))
                    MINUTES=$(((DIFF % 3600) / 60))
                    printf "%-8s: %s (ุจุงูู %02d:%02d)\n" "${AR_NAMES[$i]}" "$TIME" "$HOURS" "$MINUTES"
                else
                    printf "%-8s: %s (ูุฑุช)\n" "${AR_NAMES[$i]}" "$TIME"
                fi
            fi
        done
    else
        echo "โ ุชุนุฐุฑ ุฌูุจ ููุงููุช ุงูุตูุงุฉ"
    fi
}

# ---------------- ุฅุนุฏุงุฏุงุช ุงูุฃูููุฉ ----------------
setup_wizard() {
    echo "๐ฏ ุฅุนุฏุงุฏ GT-salat-dikr"
    echo "======================"
    
    # ูุดู ุงููููุน ุงูุชููุงุฆู
    echo "๐ ุฌุงุฑู ูุดู ูููุนู ุงูุชููุงุฆู..."
    if curl -fsSL "http://ip-api.com/json/" | jq -r '"\(.lat),\(.lon),\(.city),\(.country)"' > /tmp/location.txt 2>/dev/null; then
        LAT=$(cut -d, -f1 /tmp/location.txt)
        LON=$(cut -d, -f2 /tmp/location.txt)
        CITY=$(cut -d, -f3 /tmp/location.txt)
        COUNTRY=$(cut -d, -f4 /tmp/location.txt)
        echo "โ ุชู ุชุญุฏูุฏ ูููุนู: $CITY, $COUNTRY"
    else
        echo "โ ุชุนุฐุฑ ูุดู ุงููููุน ุชููุงุฆูุงู"
        read -p "๐ ุฃุฏุฎู ุฎุท ุงูุนุฑุถ (ูุซุงู 24.7136): " LAT
        read -p "๐ ุฃุฏุฎู ุฎุท ุงูุทูู (ูุซุงู 46.6753): " LON
        read -p "๐๏ธ  ุฃุฏุฎู ุงููุฏููุฉ: " CITY
        read -p "๐ ุฃุฏุฎู ุงูุฏููุฉ: " COUNTRY
    fi
    
    # ุทุฑููุฉ ุงูุญุณุงุจ
    echo "๐ ุงุฎุชุฑ ุทุฑููุฉ ุญุณุงุจ ููุงููุช ุงูุตูุงุฉ:"
    echo "1) Muslim World League"
    echo "2) Egyptian General Authority of Survey"
    echo "3) Umm Al-Qura University, Makkah"
    read -p "ุงุฎุชุฑ ุฑูู ุงูุทุฑููุฉ [1]: " METHOD_CHOICE
    METHOD_CHOICE=${METHOD_CHOICE:-1}
    
    case $METHOD_CHOICE in
        1) METHOD_ID=3 ;;
        2) METHOD_ID=5 ;;
        3) METHOD_ID=4 ;;
        *) METHOD_ID=3 ;;
    esac
    
    # ุงูุฅุนุฏุงุฏุงุช
    read -p "๐ ูู ุชุฑูุฏ ุงูุชูุจูู ูุจู ุงูุตูุงุฉ ุจู10 ุฏูุงุฆูุ [Y/n]: " PRE_ANS
    PRE_ANS=${PRE_ANS:-Y}
    PRE_PRAYER_NOTIFY=$([ "$PRE_ANS" =~ ^[Yy]$ ] && echo 1 || echo 0)
    
    # ุญูุธ ุงูุฅุนุฏุงุฏุงุช
    cat > "$CONFIG_FILE" <<EOF
LAT="$LAT"
LON="$LON"
CITY="$CITY"
COUNTRY="$COUNTRY"
METHOD_ID="$METHOD_ID"
PRE_PRAYER_NOTIFY="$PRE_PRAYER_NOTIFY"
EOF
    
    echo "โ ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ"
}

# ---------------- ุญููุฉ ุงูุฅุดุนุงุฑุงุช ุงูุฑุฆูุณูุฉ ----------------
notify_loop() {
    echo "๐ ุจุฏุก ุญููุฉ ุงูุฅุดุนุงุฑุงุช..." >> "$LOG_FILE"
    
    while true; do
        # ุชุญููู ุงูุฅุนุฏุงุฏุงุช ูู ูู ุฏูุฑุฉ
        if [ -f "$CONFIG_FILE" ]; then
            source "$CONFIG_FILE"
        else
            echo "โ ููู ุงูุฅุนุฏุงุฏุงุช ููููุฏ" >> "$LOG_FILE"
            sleep 60
            continue
        fi
        
        # 1. ุฅุดุนุงุฑ ุงูุฃุฐูุงุฑ ุงูุนุดูุงุฆู
        if [ -f "$AZKAR_FILE" ]; then
            ZEKR=$(awk -v RS="%" '{gsub(/^[ \t\r\n]+|[ \t\r\n]+$/, "", $0); if(length($0)>20) print $0}' "$AZKAR_FILE" | shuf -n 1)
            if [ -n "$ZEKR" ]; then
                notify-send "๐ฟ ุฐูุฑ" "$ZEKR"
                echo "๐จ ุชู ุฅุฑุณุงู ุฐูุฑ: $(echo "$ZEKR" | head -c 50)..." >> "$LOG_FILE"
            fi
        fi
        
        # 2. ุงูุชุญูู ูู ููุงููุช ุงูุตูุงุฉ
        TODAY=$(date +%Y-%m-%d)
        URL="$ALADHAN_API_URL/$TODAY?latitude=$LAT&longitude=$LON&method=$METHOD_ID"
        
        if curl -fsSL "$URL" -o "$TIMETABLE_FILE"; then
            PRAYERS=("Fajr" "Dhuhr" "Asr" "Maghrib" "Isha")
            AR_NAMES=("ุงููุฌุฑ" "ุงูุธูุฑ" "ุงูุนุตุฑ" "ุงููุบุฑุจ" "ุงูุนุดุงุก")
            NOW_SECS=$(date +%s)
            
            for i in "${!PRAYERS[@]}"; do
                TIME=$(jq -r ".data.timings.${PRAYERS[$i]}" "$TIMETABLE_FILE" | cut -d" " -f1)
                if [ "$TIME" != "null" ]; then
                    PRAYER_SECS=$(date -d "$(date +%Y-%m-%d) $TIME" +%s 2>/dev/null || date -d "$TIME" +%s)
                    DIFF=$((PRAYER_SECS - NOW_SECS))
                    
                    # ุฅุดุนุงุฑ ูุจู ุงูุตูุงุฉ ุจู10 ุฏูุงุฆู
                    if [ "$PRE_PRAYER_NOTIFY" = "1" ] && [ $DIFF -le 600 ] && [ $DIFF -gt 0 ]; then
                        echo "โฐ ุฅุดุนุงุฑ ูุจู ุงูุตูุงุฉ: ${AR_NAMES[$i]} ($TIME)" >> "$LOG_FILE"
                        notify-send "๐ ุตูุงุฉ ูุฑูุจุฉ" "ุชุจูู 10 ุฏูุงุฆู ุนูู ุตูุงุฉ ${AR_NAMES[$i]} ($TIME)"
                    fi
                    
                    # ุฅุดุนุงุฑ ููุช ุงูุตูุงุฉ
                    if [ $DIFF -le 0 ] && [ $DIFF -gt -300 ]; then
                        echo "๐ ุฅุดุนุงุฑ ููุช ุงูุตูุงุฉ: ${AR_NAMES[$i]}" >> "$LOG_FILE"
                        notify-send "๐ ุญุงู ููุช ุงูุตูุงุฉ" "ุญุงู ุงูุขู ููุช ุตูุงุฉ ${AR_NAMES[$i]} ($TIME)"
                        
                        # ุชุดุบูู ุงูุฃุฐุงู ุฅู ูุฌุฏ
                        if [ -f "$ADHAN_FILE" ]; then
                            if command -v mpv >/dev/null 2>&1; then
                                mpv --no-video --really-quiet "$ADHAN_FILE" >/dev/null 2>&1 &
                            elif command -v paplay >/dev/null 2>&1; then
                                paplay "$ADHAN_FILE" >/dev/null 2>&1 &
                            fi
                        fi
                    fi
                fi
            done
        else
            echo "โ ูุดู ุฌูุจ ููุงููุช ุงูุตูุงุฉ" >> "$LOG_FILE"
        fi
        
        # ุงูุงูุชุธุงุฑ 5 ุฏูุงุฆู ุจูู ูู ุฏูุฑุฉ
        sleep 300
    done
}

# ---------------- ุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช ----------------
start_notify() {
    cd "$SCRIPT_DIR" || { echo "โ ูุดู ุงูุงูุชูุงู ุฅูู $SCRIPT_DIR"; return 1; }
    
    # ุฃููู ุฃู ุนูููุงุช ุณุงุจูุฉ
    stop_notify >/dev/null 2>&1
    
    echo "๐ ุจุฏุก ุฅุดุนุงุฑุงุช GT-salat-dikr..."
    
    # ุงุจุฏุฃ ุงูุนูููุฉ ูู ุงูุฎูููุฉ
    nohup bash -c '
        cd "'"$SCRIPT_DIR"'"
        "'"$SCRIPT_DIR"'/gt-salat-dikr.sh" notify_loop
    ' > "$LOG_FILE" 2>&1 &
    
    local LOOP_PID=$!
    echo "$LOOP_PID" > "$PID_FILE"
    
    sleep 2
    if kill -0 "$LOOP_PID" 2>/dev/null; then
        echo "โ ุชู ุจุฏุก ุงูุฅุดุนุงุฑุงุช (PID: $LOOP_PID)"
        echo "๐ ุงูุณุฌูุงุช: $LOG_FILE"
    else
        echo "โ ูุดู ูู ุจุฏุก ุงูุฅุดุนุงุฑุงุช"
        rm -f "$PID_FILE"
    fi
}

stop_notify() {
    cd "$SCRIPT_DIR" || return 1
    
    if [ -f "$PID_FILE" ]; then
        local PID=$(cat "$PID_FILE")
        if kill -0 "$PID" 2>/dev/null; then
            kill "$PID" 2>/dev/null
            sleep 1
            rm -f "$PID_FILE"
            echo "โ ุชู ุฅููุงู ุงูุฅุดุนุงุฑุงุช"
        else
            echo "โน๏ธ ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุดุบุงูุฉ"
            rm -f "$PID_FILE"
        fi
    else
        echo "โน๏ธ ูุง ุชูุฌุฏ ุฅุดุนุงุฑุงุช ุดุบุงูุฉ"
    fi
    
    # ุชูุธูู ุฅุถุงูู
    pkill -f "gt-salat-dikr" 2>/dev/null || true
}

# ---------------- ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ----------------
case "${1:-}" in
    --show-timetable|t)
        show_timetable
        ;;
    --settings)
        setup_wizard
        ;;
    --notify-start)
        start_notify
        ;;
    --notify-stop)
        stop_notify
        ;;
    --update-azkar)
        echo "๐ฅ ุฌุงุฑู ุชุญุฏูุซ ุงูุฃุฐูุงุฑ..."
        if curl -fsSL "$REPO_AZKAR_URL" -o "$AZKAR_FILE"; then
            echo "โ ุชู ุชุญุฏูุซ ุงูุฃุฐูุงุฑ ุจูุฌุงุญ"
        else
            echo "โ ูุดู ุชุญุฏูุซ ุงูุฃุฐูุงุฑ"
        fi
        ;;
    notify_loop)
        # ูุฐุง ููุงุณุชุฎุฏุงู ุงูุฏุงุฎูู ููุท
        notify_loop
        ;;
    --help|-h)
        echo "๐ GT-salat-dikr - ูุณุงุนุฏ ุงูุตูุงุฉ ูุงูุฃุฐูุงุฑ"
        echo "======================================"
        echo "gtsalat                    ุนุฑุถ ุฐูุฑ ูููุงููุช ุงูุตูุงุฉ"
        echo "gtsalat --show-timetable   ุนุฑุถ ููุงููุช ุงูุตูุงุฉ ูุงููุฉ"
        echo "gtsalat --notify-start     ุจุฏุก ุงูุฅุดุนุงุฑุงุช ุงูุชููุงุฆูุฉ"
        echo "gtsalat --notify-stop      ุฅููุงู ุงูุฅุดุนุงุฑุงุช ุงูุชููุงุฆูุฉ"
        echo "gtsalat --settings         ุชุบููุฑ ุงูุฅุนุฏุงุฏุงุช"
        echo "gtsalat --update-azkar     ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฃุฐูุงุฑ"
        echo "gtsalat --help             ุนุฑุถ ูุฐู ุงููุณุงุนุฏุฉ"
        ;;
    *)
        # ุงููุถุน ุงูุนุงุฏู: ุนุฑุถ ุฐูุฑ ูููุงููุช ุงูุตูุงุฉ
        if [ -f "$AZKAR_FILE" ]; then
            ZEKR=$(awk -v RS="%" '{gsub(/^[ \t\r\n]+|[ \t\r\n]+$/, "", $0); if(length($0)>20) print $0}' "$AZKAR_FILE" | shuf -n 1)
            if [ -n "$ZEKR" ]; then
                echo "๐ฟ $ZEKR"
                echo ""
            fi
        fi
        
        show_timetable
        ;;
esac
